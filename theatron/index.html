<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chamber-specific meta -->
    <title>THEATRON | ET CETER4</title>
    <meta
      name="description"
      content="Performance recordings, rehearsals, and stage documentation from the THEATRON chamber"
    />
    <meta name="author" content="ET CETER4" />

    <!-- Open Graph -->
    <meta property="og:title" content="THEATRON | ET CETER4" />
    <meta property="og:description" content="Performance recordings, rehearsals, and stage documentation" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="ET CETER4" />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/vendor/tachyons/css/tachyons.min.css" />
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/chamber-colors.css" />
    <link rel="stylesheet" href="../css/video-player.css" />
    <link rel="stylesheet" href="css/theatron.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../img/favicon.ico" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#800080" />
  </head>

  <body class="min-vh-100 w-100 futura fw1 theatron-chamber">
    <!-- Skip to main content link for accessibility -->
    <a href="#chamber-content" class="skip-link" aria-label="Skip to main content">Skip to main content</a>

    <!-- Chamber Header -->
    <header
      class="chamber-header fixed top-0 left-0 w-100 z-5 pa3 theatron-header"
      style="background: rgba(0, 0, 0, 0.9)"
    >
      <nav class="flex justify-between items-center mw9 center" aria-label="Chamber navigation">
        <a href="../index.html#menu" class="chamber-back-btn white f6 link flex items-center hover-theatron">
          <span class="mr2">&larr;</span>
          <span>Back to Naos</span>
        </a>
        <h1 class="ma0 f4 tracked-mega theatron-text" style="text-shadow: 0 0 20px rgba(128, 0, 128, 0.4)">THEATRON</h1>
        <div class="chamber-nav-spacer w4"></div>
      </nav>
    </header>

    <!-- Main Content Area -->
    <main
      id="chamber-content"
      class="pt5 pb5 min-vh-100 theatron-main"
      role="main"
      aria-label="THEATRON chamber content"
    >
      <!-- Chamber Hero Section -->
      <section
        class="chamber-hero theatron-hero flex flex-column justify-center items-center tc"
        style="
          background: linear-gradient(
            180deg,
            rgba(128, 0, 128, 0.15) 0%,
            rgba(128, 0, 128, 0.05) 50%,
            transparent 100%
          );
        "
      >
        <!-- Spotlight effect overlay -->
        <div class="theatron-spotlight"></div>

        <h2
          class="f-headline-ns f1 tracked-mega ma0 mb3 theatron-hero-title"
          style="color: #800080; position: relative; z-index: 2"
        >
          THEATRON
        </h2>
        <p class="bodoni f4 o-80 mw6 ph4 theatron-hero-subtitle" style="position: relative; z-index: 2">
          Performance recordings, rehearsals, stage
        </p>
      </section>

      <!-- Content Grid -->
      <section id="chamber-grid" class="mw9 center ph4 pv5">
        <!-- Section Navigation -->
        <div class="chamber-section-nav flex flex-wrap justify-center mb5 gap-3">
          <button class="theatron-section-btn active" data-section="performances" aria-label="View performances">
            <span class="theatron-section-label">PERFORMANCES</span>
          </button>
          <button class="theatron-section-btn" data-section="rehearsals" aria-label="View rehearsals">
            <span class="theatron-section-label">REHEARSALS</span>
          </button>
        </div>

        <!-- Video Player Section (above content grid) -->
        <section id="video-player-section" class="theatron-player-section mb5" style="display: none">
          <div class="theatron-video-player-container">
            <div id="theatron-video-container" class="theatron-player-frame">
              <!-- EnhancedVideoPlayer renders here -->
            </div>
            <div id="video-info" class="mt3 pa3 bg-black-40 br2">
              <h3 id="video-title" class="f4 theatron-text mb2 tracked"></h3>
              <p id="video-meta" class="f6 white-70 mb2"></p>
              <p id="video-description" class="f7 white-60"></p>
              <!-- Chapters list -->
              <div id="video-chapters" class="mt3" style="display: none">
                <h4 class="f6 theatron-text-light mb2 tracked">CHAPTERS</h4>
                <ul id="chapters-list" class="list pl0 ma0"></ul>
              </div>
            </div>
            <!-- Quality selector -->
            <div id="quality-selector" class="mt3 flex items-center gap-2" style="display: none">
              <span class="f7 white-60">Quality:</span>
              <select id="quality-select" class="bg-black-60 white bn pa2 br2 f7" aria-label="Video quality selection">
                <option value="auto">Auto</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Performances Section -->
        <div id="performances-section" class="theatron-section active">
          <h3 class="f3 tracked-mega mb4 theatron-section-title">PERFORMANCES</h3>
          <div id="chamber-items-performances" class="flex flex-wrap justify-center gap-4">
            <!-- Performance cards rendered by JS -->
          </div>
        </div>

        <!-- Rehearsals Section -->
        <div id="rehearsals-section" class="theatron-section">
          <h3 class="f3 tracked-mega mb4 theatron-section-title">REHEARSALS</h3>
          <div id="chamber-items-rehearsals" class="flex flex-wrap justify-center gap-4">
            <!-- Rehearsal cards rendered by JS -->
          </div>
        </div>
      </section>
    </main>

    <!-- Chamber Footer -->
    <footer class="chamber-footer fixed bottom-0 w-100 pa3 bg-black-90 theatron-footer" role="contentinfo">
      <nav class="flex justify-center items-center" aria-label="Footer navigation">
        <a href="../index.html#landing" class="white-70 f7 link mh3 hover-theatron">ETCETER4</a>
        <span class="white-30">//</span>
        <a href="../index.html#menu" class="white-70 f7 link mh3 hover-theatron">NAOS</a>
        <span class="white-30">//</span>
        <a href="../sitemap.html" class="white-70 f7 link mh3 hover-theatron">SITE MAP</a>
      </nav>
    </footer>

    <!-- Scripts -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/velocity/2.0.6/velocity.min.js"
      integrity="sha512-+ZPnKPFqf/PjXPKJLBykOgAOnUmCp0ufqCYWsuvMV5FhlYCf/DlTdB3PQJuXzA3otXm1FiooUNrBncLRLbYaxA=="
      crossorigin="anonymous"
    ></script>
    <!-- HLS.js for adaptive streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <!-- Core scripts -->
    <script type="text/javascript" src="../js/config.js"></script>
    <script type="text/javascript" src="../js/media/MediaURLResolver.js"></script>
    <script type="text/javascript" src="../js/media/video/EnhancedVideoPlayer.js"></script>
    <script type="text/javascript" src="../js/living-pantheon/LivingPantheonCore.js"></script>
    <script type="text/javascript" src="config.js"></script>
    <script>
      'use strict';

      /**
       * TheatronChamber - Video performance chamber controller
       */
      const TheatronChamber = (function () {
        let videoPlayer = null;
        let currentVideo = null;
        let currentSection = 'performances';

        /**
         * Initialize the chamber
         */
        function initialize() {
          setupVideoPlayer();
          setupSectionNavigation();
          renderPerformanceCards('performances');
          renderPerformanceCards('rehearsals');
          initializeLivingPantheon();
        }

        /**
         * Setup the EnhancedVideoPlayer
         */
        function setupVideoPlayer() {
          const container = document.getElementById('theatron-video-container');
          if (!container) {
            return;
          }

          videoPlayer = new EnhancedVideoPlayer({
            container: container,
            hlsSupport: true,
            controls: true,
            fullscreen: true,
            volume: THEATRON_CONFIG.videoPlayer?.defaultVolume || 0.8,
          });

          // Event listeners
          videoPlayer.on('qualitiesavailable', handleQualitiesAvailable);
          videoPlayer.on('qualitychange', handleQualityChange);
          videoPlayer.on('ended', handleVideoEnded);
          videoPlayer.on('error', handleVideoError);

          // Setup quality selector
          const qualitySelect = document.getElementById('quality-select');
          if (qualitySelect) {
            qualitySelect.addEventListener('change', function () {
              videoPlayer.setQuality(this.value === 'auto' ? -1 : this.value);
            });
          }
        }

        /**
         * Handle available qualities
         */
        function handleQualitiesAvailable(data) {
          const selector = document.getElementById('quality-selector');
          const select = document.getElementById('quality-select');
          if (!selector || !select || !data.qualities) {
            return;
          }

          select.innerHTML = '<option value="auto">Auto</option>';
          data.qualities.forEach(q => {
            const option = document.createElement('option');
            option.value = q.index;
            option.textContent = q.name;
            select.appendChild(option);
          });

          selector.style.display = 'flex';
        }

        /**
         * Handle quality change
         */
        function handleQualityChange(data) {
          const select = document.getElementById('quality-select');
          if (select && data.levelIndex !== undefined) {
            select.value = data.levelIndex === -1 ? 'auto' : data.levelIndex;
          }
        }

        /**
         * Handle video ended
         */
        function handleVideoEnded() {
          // Could auto-play next video or show recommendations
        }

        /**
         * Handle video errors
         */
        function handleVideoError(data) {
          console.error('Video playback error:', data.error);
        }

        /**
         * Setup section navigation
         */
        function setupSectionNavigation() {
          const sectionBtns = document.querySelectorAll('.theatron-section-btn');
          const sections = document.querySelectorAll('.theatron-section');

          sectionBtns.forEach(btn => {
            btn.addEventListener('click', function () {
              const targetSection = this.dataset.section;
              currentSection = targetSection;

              sectionBtns.forEach(b => b.classList.remove('active'));
              this.classList.add('active');

              sections.forEach(section => {
                section.classList.remove('active');
              });
              document.getElementById(targetSection + '-section').classList.add('active');
            });
          });
        }

        /**
         * Render performance cards for a section
         */
        function renderPerformanceCards(section) {
          const container = document.getElementById('chamber-items-' + section);
          if (!container) {
            return;
          }

          const items = THEATRON_CONFIG[section] || [];

          if (items.length === 0) {
            container.innerHTML = `
              <div class="theatron-placeholder">
                <p class="theatron-text f6 tracked-mega">${section === 'performances' ? 'Performance' : 'Rehearsal'} recordings coming soon</p>
                <p class="white-60 f7">Stage documentation and video archives</p>
              </div>
            `;
            return;
          }

          container.innerHTML = items.map(item => createPerformanceCard(item)).join('');
          attachCardListeners(container);
        }

        /**
         * Create a performance card HTML
         */
        function createPerformanceCard(item) {
          const thumbUrl = item.thumbnail || MediaURLResolver.resolve(item.id + '/thumb.jpg', 'video');
          return `
            <div class="performance-card theatron-dramatic pa3 br2 pointer" data-video-id="${escapeHtml(item.id)}" tabindex="0" role="button" aria-label="Play ${escapeHtml(item.title)}">
              <div class="performance-thumbnail aspect-ratio aspect-ratio--16x9 mb2 relative overflow-hidden br2">
                <img src="${thumbUrl}" alt="${escapeHtml(item.title)}" loading="lazy" class="aspect-ratio--object cover" onerror="this.style.display='none'">
                <div class="play-overlay absolute absolute--fill flex items-center justify-center bg-black-50 o-0 hover-o-100 transition-opacity">
                  <span class="f2 theatron-text">▶</span>
                </div>
                ${item.duration ? `<span class="duration absolute bottom-0 right-0 bg-black-70 white f7 pa1 ma1 br1">${escapeHtml(item.duration)}</span>` : ''}
              </div>
              <div class="performance-info">
                <h4 class="f5 theatron-text-light tracked mb1 truncate">${escapeHtml(item.title)}</h4>
                <p class="f7 white-60 mb0">${escapeHtml(item.venue || '')}${item.venue && item.year ? ' · ' : ''}${item.year || ''}</p>
              </div>
            </div>
          `;
        }

        /**
         * Attach click listeners to cards
         */
        function attachCardListeners(container) {
          container.querySelectorAll('.performance-card').forEach(card => {
            const handler = function () {
              const videoId = this.dataset.videoId;
              const items = [...(THEATRON_CONFIG.performances || []), ...(THEATRON_CONFIG.rehearsals || [])];
              const videoData = items.find(v => v.id === videoId);
              if (videoData) {
                playVideo(videoData);
              }
            };

            card.addEventListener('click', handler);
            card.addEventListener('keypress', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handler.call(this);
              }
            });
          });
        }

        /**
         * Play a video
         */
        function playVideo(videoData) {
          if (!videoPlayer) {
            return;
          }

          currentVideo = videoData;

          // Show the video section
          const playerSection = document.getElementById('video-player-section');
          if (playerSection) {
            playerSection.style.display = 'block';
            playerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }

          // Resolve video URL
          const videoUrl = MediaURLResolver.resolveVideo(videoData.id, 'auto');

          // Load with options
          videoPlayer.load(videoUrl, {
            chapters: videoData.chapters || [],
            subtitles: videoData.subtitles || [],
            posterUrl: videoData.thumbnail || null,
          });

          // Update info display
          updateVideoInfo(videoData);

          // Auto-play
          videoPlayer.play().catch(err => {
            // Autoplay may be blocked - user can click play
          });
        }

        /**
         * Update video info display
         */
        function updateVideoInfo(videoData) {
          const titleEl = document.getElementById('video-title');
          const metaEl = document.getElementById('video-meta');
          const descEl = document.getElementById('video-description');
          const chaptersEl = document.getElementById('video-chapters');
          const chaptersList = document.getElementById('chapters-list');

          if (titleEl) {
            titleEl.textContent = videoData.title;
          }
          if (metaEl) {
            const parts = [];
            if (videoData.venue) {
              parts.push(videoData.venue);
            }
            if (videoData.year) {
              parts.push(videoData.year);
            }
            if (videoData.duration) {
              parts.push(videoData.duration);
            }
            metaEl.textContent = parts.join(' · ');
          }
          if (descEl) {
            descEl.textContent = videoData.description || '';
          }

          // Render chapters
          if (chaptersEl && chaptersList && videoData.chapters && videoData.chapters.length > 0) {
            chaptersList.innerHTML = videoData.chapters
              .map(
                (ch, i) => `
              <li class="chapter-item pv1 pointer hover-theatron" data-chapter-index="${i}" tabindex="0">
                <span class="f7 white-40 mr2">${formatTime(ch.time)}</span>
                <span class="f7 white-80">${escapeHtml(ch.title)}</span>
              </li>
            `
              )
              .join('');

            // Attach chapter click handlers
            chaptersList.querySelectorAll('.chapter-item').forEach(item => {
              item.addEventListener('click', function () {
                const index = parseInt(this.dataset.chapterIndex, 10);
                videoPlayer.goToChapter(index);
              });
            });

            chaptersEl.style.display = 'block';
          } else if (chaptersEl) {
            chaptersEl.style.display = 'none';
          }
        }

        /**
         * Format seconds to mm:ss
         */
        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        /**
         * Escape HTML special characters
         */
        function escapeHtml(str) {
          if (!str) {
            return '';
          }
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }

        /**
         * Initialize Living Pantheon
         */
        function initializeLivingPantheon() {
          if (typeof LivingPantheonCore !== 'undefined' && ETCETER4_CONFIG.livingPantheon?.enabled) {
            LivingPantheonCore.getInstance()
              .initialize({
                chamberId: 'theatron',
                chamberColor: '#800080',
              })
              .start();
          }
        }

        return {
          initialize,
          playVideo,
        };
      })();

      // Initialize on DOM ready
      document.addEventListener('DOMContentLoaded', function () {
        TheatronChamber.initialize();
      });
    </script>
  </body>
</html>
